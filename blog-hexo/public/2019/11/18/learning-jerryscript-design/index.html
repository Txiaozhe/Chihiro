<!DOCTYPE html>
<html>
  <head>
      <script>
  var _hmt = _hmt || []
  ;(function() {
    var hm = document.createElement('script')
    hm.src = 'https://hm.baidu.com/hm.js?5a0acc897fd96474a2c8f4deac84611a'
    var s = document.getElementsByTagName('script')[0]
    s.parentNode.insertBefore(hm, s)
  })()
</script> 
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    
    <title>
      JerryScript 学习笔记 - Jim Tang&#39;s blog
    </title>
    <link rel="" href="/manifest.json" />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
    
<link rel="stylesheet" href="/style/style.css">

  <meta name="generator" content="Hexo 4.1.0"><link rel="alternate" href="/atom.xml" title="Jim Tang's blog" type="application/atom+xml">
</head>
  <body>
    <!-- 
    <div id="post-toc" class="animated hiddenToc hide">
      <span class="title">Toc</span>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Parser"><span class="toc-text">Parser</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Lexer"><span class="toc-text">Lexer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Scanner"><span class="toc-text">Scanner</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Expression-Parser"><span class="toc-text">Expression Parser</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Statement-Parser"><span class="toc-text">Statement Parser</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Byte-code"><span class="toc-text">Byte-code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#编译的字节码的内存布局"><span class="toc-text">编译的字节码的内存布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#字节码内存布局"><span class="toc-text">字节码内存布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Literal（字面量）"><span class="toc-text">Literal（字面量）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Literal-Store"><span class="toc-text">Literal Store</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Byte-code-Categories（字节码类别）"><span class="toc-text">Byte-code Categories（字节码类别）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Push-字节码"><span class="toc-text">Push 字节码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Call-字节码"><span class="toc-text">Call 字节码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Arithmetic-Logical-Bitwise-and-Assignment-字节码（算数、逻辑、位、赋值）"><span class="toc-text">Arithmetic, Logical, Bitwise and Assignment 字节码（算数、逻辑、位、赋值）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Branch-字节码"><span class="toc-text">Branch 字节码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Snapshot（快照）"><span class="toc-text">Snapshot（快照）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Virtual-Machine（虚拟机）"><span class="toc-text">Virtual Machine（虚拟机）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ECMA"><span class="toc-text">ECMA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据表示"><span class="toc-text">数据表示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#压缩指针"><span class="toc-text">压缩指针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数字"><span class="toc-text">数字</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#字符串"><span class="toc-text">字符串</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Object-Lexical-Environment（词汇环境）"><span class="toc-text">Object &#x2F; Lexical Environment（词汇环境）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#对象属性"><span class="toc-text">对象属性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#property-hashmap（属性hash表）"><span class="toc-text">property hashmap（属性hash表）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#内部属性"><span class="toc-text">内部属性</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LCache"><span class="toc-text">LCache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Collections"><span class="toc-text">Collections</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exception-Handling（异常处理）"><span class="toc-text">Exception Handling（异常处理）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Value-Management-and-Ownership（值管理和所有权）"><span class="toc-text">Value Management and Ownership（值管理和所有权）</span></a></li></ol></li></ol></li></ol>
    </div>
     -->
    <div id="fixed-menu-wrap">
      <span class="iconfont icon-sousuo search-box menu-reset"></span>
      <!-- <span class="icon-toc menu-reset">Toc</span> -->
      <span class="iconfont icon-arrowup menu-reset"></span>
    </div>
    <div id="fixed-menu">
      <span class="iconfont icon-menu-"></span>
    </div>
    <div id="progress">
      <div class="line"></div>
    </div>
    <div id="search-shade" class="animated hiddenSearch hide">
      <div class="input-wrap">
        <span class="iconfont icon-sousuo search-box"></span>
        <input type="text" placeholder="Search" />
        <span class="iconfont icon-close"></span>
      </div>
      <div class="search-result">
        <div class="meta">
          <span><b id="result-count">0</b> results found</span>
          <img src="/images/logo.png" />
        </div>
        <ul id="result-box"></ul>
      </div>
    </div>
    <div id="menu-mask" class="animated hideMenuMask hide">
      <span class="iconfont icon-close"></span>
      <div class="nav">
        
        <a href="/" class="">
          首页
        </a>
        
        <a href="/archives" class="">
          归档
        </a>
        
        <a href="/categories" class="">
          分类
        </a>
        
        <a href="/tags" class="">
          标签
        </a>
        
        <a href="/about" class="">
          关于
        </a>
        
      </div>
    </div>
    <div id="header">
      <div class="intro">
        <a href="/" class="logo" style="background-image: url('/images/')"></a>
        <div class="author">Jim Tang</div>
      </div>
      <div class="nav">
        <span class="iconfont icon-menu menu-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
    </div>
    <div id="side" class="animated bounceInLeft">
      <div class="shrink">
        <a href="/" class="logo" style="background-image: url('/images/logo.png')"></a>
        <span class="iconfont icon-menu toggle-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
      <div class="magnify">
        <div class="about">
          <div class="author">Jim Tang</div>
          <a href="/" class="logo" style="background-image: url('/images/logo.png')"></a>
        </div>

        <div class="nav">
          
          <a href="/" class="">
            首页
          </a>
          
          <a href="/archives" class="">
            归档
          </a>
          
          <a href="/categories" class="">
            分类
          </a>
          
          <a href="/tags" class="">
            标签
          </a>
          
          <a href="/about" class="">
            关于
          </a>
          
          <a href="#" class="search-box">
            <span class="iconfont icon-sousuo"></span>
          </a>
        </div>
        <div class="bottom">
          <div class="follow">
            
            <a href="https://github.com/Txiaozhe" target="_block">
              <span class="iconfont icon-github"></span>
            </a>
            
            <a href="https://www.zhihu.com/people/txiaozhe/activities" target="_block">
              <span class="iconfont icon-zhihu"></span>
            </a>
             
            <a href="/atom.xml" target="_block">
              <span class="iconfont icon-rss"></span>
            </a>
            
          </div>
        </div>
      </div>
    </div>
    <div id="container">
      <div class="main animated bounceInRight delay-0.7s">
        <article class="post-entry">
    <div class="header">
      
      <div class="title">JerryScript 学习笔记</div>
      <div class="meta">
        <span class="item">
          <span class="iconfont icon-time-circle"></span>
          <span>2019/11/18</span>
        </span>

        
          <span class="item leancloud-visitors" id="/2019/11/18/learning-jerryscript-design/" data-flag-title="JerryScript 学习笔记">
            <span class="iconfont icon-eye1"></span>
            <span class="leancloud-visitors-count"></span>
          </span>
        

         
        <span class="item">
          <span class="iconfont icon-folder"></span>
          <span>
              
                
                  <a href="/categories/Tech">Tech</a>
                
              
                
                  <a href="/categories/Translate">Translate</a>
                
              
          </span>
        </span>
        
        
         
          <span class="item">
            <span class="iconfont icon-tag1"></span>
            <span>
                
                  
                    <a href="/tags/JavaScript">JavaScript</a>
                  
                
                  
                    <a href="/tags/JerryScript">JerryScript</a>
                  
                
            </span>
          </span>
         
      </div>
      <div>
      </div>
    </div>
    <p>这是 JerryScript 官网的一段简介：<br><a href="/images/jerryscript-introduce.png" data-caption data-fancybox="images"><img src="/images/jerryscript-introduce.png" alt></a></p>
<blockquote>
<p><strong>简单翻译一下：</strong></p>
<p>JerryScript 是一个为 IoT 而开发的轻量级  JavaScript 引擎，可以运行在资源十分受限的设备上，比如：</p>
<ul>
<li>RAM 低于 64KB 的设备</li>
<li>ROM 低于 200KB 的设备</li>
</ul>
<p>该引擎支持在设备上解释、执行 JavaScript 以及对外围设备的访问。</p>
</blockquote>
<p>说白了 JerryScript 和我们日常用的 Chrome 和 Node.js 中的 V8 是一回事，是一个引擎，只不过  JerryScript 能运行在更加低端的设备上，如嵌入式设备。我们知道，JavaScript 作为一个脚本语言有其先天的缺陷，如解释执行的效率低下以及臃肿的堆内存的占用，哪怕 V8 的设计与实现已经做了大量的优化与改进，但距离能运行在 RAM 以 KB 为单位的设备上还差得很远。这不禁使人产生疑问，同样是对统一标准的实现，JerryScript 凭什么做到运行在 RAM 低于 64KB，ROM 低于 200KB 的设备上这种骚操作。本文是对 <a href="https://jerryscript.net/internals/" target="_blank" rel="noopener">JerryScript 的官方文档</a> 的翻译。</p>
<p><a href="https://jerryscript.net/img/engines_high_level_design.png" target="_blank" rel="noopener" data-caption data-fancybox="images"><img src="https://jerryscript.net/img/engines_high_level_design.png" alt></a></p>
<p>如上图，Parser(解析器) 和 VM(虚拟机) 是 JerryScript 的两个核心组件。一般来说 JerryScript 运行的基本流程，首先，Parser 将加载到的 JS 标准代码解析成具有特殊格式的字节码，然后由 VM 对字节码进行执行。</p>
<h2 id="Parser">Parser<a class="post-anchor" href="#Parser"></a></h2><p>在 JerryScript 里，Parser 被设计为 recursive descent parser（递归下降解析器），这样的解析器可以直接将标准 JS 代码转换成字节码而并不像 V8 那样会构建一个 AST。这里的实现依赖以下四个组件：Lexer（词法分析器）、 Scanner、Expression Parser（表达式解析器）以及 Statement Parser（语句解析器）。</p>
<h3 id="Lexer">Lexer<a class="post-anchor" href="#Lexer"></a></h3><p>将输入的代码字符串切分成标识符序列，其不仅可以按顺序向前扫描输入字符串，而且可以移动到任意位置。</p>
<h3 id="Scanner">Scanner<a class="post-anchor" href="#Scanner"></a></h3><p>对输入的字符串进行预扫描并搜索特定字符，比如这一步可以确定出现 <code>for</code> 的地方代表了常规的循环还是 <code>for-in</code> 循环。</p>
<h3 id="Expression-Parser">Expression Parser<a class="post-anchor" href="#Expression-Parser"></a></h3><p>负责解析 JavaScript 表达式。</p>
<h3 id="Statement-Parser">Statement Parser<a class="post-anchor" href="#Statement-Parser"></a></h3><p>负责解析 JavaScript 语句。</p>
<p><a href="https://jerryscript.net/img/parser_dependency.png" target="_blank" rel="noopener" data-caption data-fancybox="images"><img src="https://jerryscript.net/img/parser_dependency.png" alt></a></p>
<p>上图展示了 Parser 中几个主要组件的相互作用，函数 <code>parser_parse_source</code> 对输入的 ES 源代码进行解析和编译，当遇到函数时，调用 <code>parser_parse_function</code>对代码进行递归操作，包括参数解析和上下文处理。解析之后，<code>parser_post_processing</code> 函数转储创建的操作码并返回一个 <code>ecma_compiled_code_t *</code> 指针，它指向已编译的字节码序列。</p>
<h2 id="Byte-code">Byte-code<a class="post-anchor" href="#Byte-code"></a></h2><p>与其他 JS 引擎的实现相比，JerryScript 实现了更加紧凑的字节码形式（CBC），和其他只关注性能的实现相比，一方面减少了字节码的内存消耗，同时又具有可观的性能。CBC 类似于 CISC 指令集，可为频繁的操作分配较短的指令。 许多指令表示多个原子操作，减少了字节码体积，这类似于一种数据压缩方法。</p>
<h3 id="编译的字节码的内存布局">编译的字节码的内存布局<a class="post-anchor" href="#编译的字节码的内存布局"></a></h3><p><a href="https://jerryscript.net/img/CBC_layout.png" target="_blank" rel="noopener" data-caption data-fancybox="images"><img src="https://jerryscript.net/img/CBC_layout.png" alt></a></p>
<ul>
<li>header 表示一个具有多个域的 cbc_compiled_code 结构，这些域包含了字节码的关键属性。</li>
<li>literial 部分是一个 ecma 值的数组，这些值包含了 ECMAScript 定义的数据类型，比如 string、number、function等等。该数组长度由 header 中的 literal_end 字段指定。</li>
<li>CBC instruction list 是一系列的字节码指令，他们代表编译后的代码。</li>
</ul>
<h3 id="字节码内存布局">字节码内存布局<a class="post-anchor" href="#字节码内存布局"></a></h3><p><a href="https://jerryscript.net/img/opcode_layout.png" target="_blank" rel="noopener" data-caption data-fancybox="images"><img src="https://jerryscript.net/img/opcode_layout.png" alt></a></p>
<p>每一个字节码都由 opcode 开头。常见指令的 opcode 为1字节，反之稀有指令的为2字节。稀有指令的第一个字节始终为零（CBC_EXT_OPCODE），第二个字节表示扩展操作码。 常见指令和稀有指令的名称分别以 CBC_ 和CBC_EXT_ 前缀开头。</p>
<p>由于可以定义 255个公共指令（不包括零值）和256个稀有指令，因此 opcode 的最大个数是 511，目前大约有215条常见指令和70条稀有指令可用。</p>
<p>在 CBC 中有3种字节码参数：</p>
<ul>
<li><strong>byte argument</strong>（字节参数）：介于0~255之间的值，通常代表操作码操作调用的参数计数（函数、new、eval等）</li>
<li><strong>literal argument</strong>（字面量参数）：在header中介于0~literal_end（包含0）之间的整数索引的域</li>
<li><strong>relative branch</strong>（相对分支参数）：长度为1~3个字节的偏移量。分支参数也可能代表指令范围的结尾。 例如，<code>CBC_EXT_WITH_CREATE_CONTEXT</code> 的 branch 参数显示 with 语句的结尾。 更确切地说，with子句中最后一条指令之后的位置</li>
</ul>
<p>参数之间的组合限于以下7种情况：</p>
<ul>
<li>无参数</li>
<li>只有一个字面量参数</li>
<li>只有一个字节参数</li>
<li>只有一个分支参数</li>
<li>一个字节参数和一个字面量参数</li>
<li>两个字面量参数</li>
<li>三个字面量参数</li>
</ul>
<h3 id="Literal（字面量）">Literal（字面量）<a class="post-anchor" href="#Literal（字面量）"></a></h3><p>字面量被按照不同的类型组成字面量组，这与为每个字面量分配标志位相比更加节省空间。（以下提到的范围代表大于或等于范围左侧和小于右侧的那些标记。例如，字节码标头的ident_end和literal_end字段之间的范围包含这些标记， 大于或等于ident_end且小于literal_end。如果ident_end等于literal_end，则范围为空。）</p>
<p><em>identifiers</em>（标识符） 和 <em>values</em>（值） 是两个主要的字面量组：</p>
<ul>
<li><strong>identifier</strong>：表示变量的名字。在 header 中字面量值介于0~ident_end之间。这种字面量必须为 string 或 undefined。undefined只能用来表示该字面量无法通过字面量名字访问到的情况。比如 <code>function () {arg, arg}</code>有两个参数，但这里的 arg 只能用来引用第二个参数。在这种情况下，第一个参数的名字就是 undefined。此外，诸如 CSE 之类的优化也可能引入不带名称的字面量。</li>
<li><strong>value</strong>：表示立即值的引用。字面量值介于 ident_end 和 const_literal_end 之间的数字或字符串等。这种字面量可以直接被 VM 所使用。字面量值介于 const_literal_end 和 literal_end 的是模板字面量，比如函数和正则表达式。每次访问这类值都需要构造一个新对象。</li>
</ul>
<p>identifiers 还有另外两个子组。寄存器是存储在函数调用堆栈中的那些标识符。 参数是由调用程序函数传递的那些寄存器。</p>
<p>在 CBC 中有两种类型的字面量编码，都是可变长度，1或2个字节。</p>
<ul>
<li><strong>small</strong>：最多可以编码511个字面量</li>
</ul>
<p>单字节编码  0 - 254 之间的字面量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">byte[0] &#x3D; literal_index<br></code></pre></td></tr></table></figure>

<p>双字节编码 255 - 510 之间的字面量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">byte[0] &#x3D; 0xff<br>byte[1] &#x3D; literal_index - 0xff<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>full</strong>：最多可以编码 32767 个字面量</li>
</ul>
<p>单字节编码  0 - 127 之间的字面量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">byte[0] &#x3D; literal_index<br></code></pre></td></tr></table></figure>

<p>双字节编码 128 - 32767 之间的字面量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">byte[0] &#x3D; (literal_index &gt;&gt; 8) | 0x80<br>byte[1] &#x3D; (literal_index &amp; 0xff)<br></code></pre></td></tr></table></figure>

<p>因为大多数函数需要的字面量小于 255，所以 small 编码为所有字面量提供了一个单字节的字面量索引。与 full 编码相比，small 编码占用更少的空间但是范围有限。</p>
<h3 id="Literal-Store">Literal Store<a class="post-anchor" href="#Literal-Store"></a></h3><p>JerryScript 没有用于字面量的全局字符串表，但是将它们存储在文字存储中。 在解析阶段，如果出现一个新的字面量，若其标识符与现有的标识符相同，则不会再次存储该字符串，但会使用字面量存储区中的标识符。 如果一个新的字面量不在Literal Store中，它将被插入。</p>
<h3 id="Byte-code-Categories（字节码类别）">Byte-code Categories（字节码类别）<a class="post-anchor" href="#Byte-code-Categories（字节码类别）"></a></h3><p>字节码可以被分为四个主要的类别：</p>
<h4 id="Push-字节码">Push 字节码<a class="post-anchor" href="#Push-字节码"></a></h4><h4 id="Call-字节码">Call 字节码<a class="post-anchor" href="#Call-字节码"></a></h4><h4 id="Arithmetic-Logical-Bitwise-and-Assignment-字节码（算数、逻辑、位、赋值）">Arithmetic, Logical, Bitwise and Assignment 字节码（算数、逻辑、位、赋值）<a class="post-anchor" href="#Arithmetic-Logical-Bitwise-and-Assignment-字节码（算数、逻辑、位、赋值）"></a></h4><h4 id="Branch-字节码">Branch 字节码<a class="post-anchor" href="#Branch-字节码"></a></h4><h3 id="Snapshot（快照）">Snapshot（快照）<a class="post-anchor" href="#Snapshot（快照）"></a></h3><p>编译后的字节码可以保存到快照中，也可以加载回执行。 直接执行快照可以节省解析源的内存消耗和性能成本。 也可以直接从 ROM 执行快照，在这种情况下，还可以节省将快照加载到内存中的开销。</p>
<h2 id="Virtual-Machine（虚拟机）">Virtual Machine（虚拟机）<a class="post-anchor" href="#Virtual-Machine（虚拟机）"></a></h2><p>虚拟机是一个解释器，可逐一执行字节码指令。 解释的函数是位于 <code>./jerry-core/vm/vm.c</code> 的 vm_run。 vm_loop是虚拟机的主循环，它具有非递归特性。 这意味着在函数调用的情况下，它不会递归地调用自身而是返回，这具有的好处是与递归实现相比不会加重堆栈。</p>
<h2 id="ECMA">ECMA<a class="post-anchor" href="#ECMA"></a></h2><p>引擎中 ECMA 组件负责以下四个功能：</p>
<ul>
<li>数据表示</li>
<li>运行时</li>
<li>GC</li>
</ul>
<h3 id="数据表示">数据表示<a class="post-anchor" href="#数据表示"></a></h3><p>数据表示的主要结构是 ECMA_value，这个结构中低三位编码了数据标签，用来确定数据类型：</p>
<ul>
<li>simple</li>
<li>number</li>
<li>string</li>
<li>object</li>
<li>symbol</li>
<li>error</li>
</ul>
<p><a href="https://jerryscript.net/img/ecma_value.png" target="_blank" rel="noopener" data-caption data-fancybox="images"><img src="https://jerryscript.net/img/ecma_value.png" alt></a></p>
<p>如果是数字，字符串和对象类型，则该值包含一个编码的指针，对于基础值是一个预定义的常量，可以是：</p>
<ul>
<li>undefined</li>
<li>null</li>
<li>true</li>
<li>false</li>
<li>empty (未初始化的值)</li>
</ul>
<h4 id="压缩指针">压缩指针<a class="post-anchor" href="#压缩指针"></a></h4><p>为了节省堆空间，引入了压缩指针：</p>
<p><a href="https://jerryscript.net/img/ecma_compressed.png" target="_blank" rel="noopener" data-caption data-fancybox="images"><img src="https://jerryscript.net/img/ecma_compressed.png" alt></a></p>
<p>这些指针是 8 字节对齐的16位指针，可以寻址 512 Kb的内存，这也是 JerryScript堆的最大容量。 为了支持更多的内存，可以在构建时加上“ –cpointer_32_bit on”，将压缩指针的大小扩展到 32位，以覆盖 32位系统的整个地址空间。 “未压缩的指针”会将内存消耗增加大约20％。</p>
<h4 id="数字">数字<a class="post-anchor" href="#数字"></a></h4><p>根据 IEEE 754标准有两种可能的数字表示形式：默认值是8字节（双精度），但是引擎也支持将 JERRY_NUMBER_TYPE_FLOAT64设置为0来支持4字节（单精度）表示方式。</p>
<p><a href="https://jerryscript.net/img/number.png" target="_blank" rel="noopener" data-caption data-fancybox="images"><img src="https://jerryscript.net/img/number.png" alt></a></p>
<p>不支持多次引用单个分配的数字。每个引用都拥有自己的副本。</p>
<h4 id="字符串">字符串<a class="post-anchor" href="#字符串"></a></h4><p>JerryScript中的字符串不仅是字符序列，而且还可以包含数字和所谓的 magic ID。 对于常见的字符序列（在 ./jerry-core/lit/lit-magic-strings.ini 中定义），只读存储器中有一个表，其中包含 magic ID和字符序列对。 如果一个字符串已经在此表中了，则将存储其字符串的 magic ID 而非字符序列本身。 使用数字可加快属性访问以达到节省内存的目的。</p>
<h4 id="Object-Lexical-Environment（词汇环境）">Object / Lexical Environment（词汇环境）<a class="post-anchor" href="#Object-Lexical-Environment（词汇环境）"></a></h4><p>对象可以是常规数据对象或词法环境对象。 与其他数据类型不同，对象可以具有对其他数据类型的引用（称为属性）。 由于有循环引用，引用计数并不总是足以确定死对象。 因此，链列表是由所有现有对象组成的，可用于在垃圾回收期间查找未引用的对象。 每个对象的 gc-next 指针显示链表中的下一个分配对象。</p>
<p><a href="http://www.ecma-international.org/ecma-262/5.1/#sec-10.2" target="_blank" rel="noopener">Lexical environments</a> 在 JerryScript 中实现为对象，因为其包含像对象一样的键值对（称为绑定）。 这简化了实现并减小了代码大小。</p>
<p><a href="https://jerryscript.net/img/ecma_object.png" target="_blank" rel="noopener" data-caption data-fancybox="images"><img src="https://jerryscript.net/img/ecma_object.png" alt></a> </p>
<p>这些对象表现为如下结构：</p>
<ul>
<li><p>引用计数器–硬（非属性）引用的数量</p>
</li>
<li><p>GC 的下一个对象指针</p>
</li>
<li><p>类型（函数对象或词汇环境等） </p>
</li>
</ul>
<h4 id="对象属性">对象属性<a class="post-anchor" href="#对象属性"></a></h4><p><a href="https://jerryscript.net/img/ecma_object_property.png" target="_blank" rel="noopener" data-caption data-fancybox="images"><img src="https://jerryscript.net/img/ecma_object_property.png" alt></a></p>
<p>对象有一个包含其属性的链表。此链表实际上包含属性对，为了节省内存：属性占7位，其类型字段占2位，共9位，这样一个字节就不够用需要占用两个字节，因此，将两个属性（14位）与2位的类型字段放在一起这样就能沾满2字节。</p>
<h5 id="property-hashmap（属性hash表）">property hashmap（属性hash表）<a class="post-anchor" href="#property-hashmap（属性hash表）"></a></h5><p>如果属性对的数量达到限制（当前此限制定义为16），则在属性对列表的第一个位置插入一个 Property Hashmap，以便使用它来查找属性，而不是通过在属性对上线性迭代来查询。</p>
<p>属性哈希表包含2^n个元素，其中 2^n 大于对象的属性数。 每个元素可以具有值的树类型：</p>
<ul>
<li>null，指代空元素</li>
<li>delete，指代被删除的元素，或者</li>
<li>对现有对象的引用</li>
</ul>
<p>hashmap 是必须返回的类型的缓存，这意味着可以通过它找到对象所有的属性。</p>
<h5 id="内部属性">内部属性<a class="post-anchor" href="#内部属性"></a></h5><p>内部属性是一些特殊的属性，这些属性包含无法由 JavaScript 代码访问的元信息，但对引擎本身很重要。 内部属性的一些示例如下所示：</p>
<ul>
<li>[[Class]] – 对象的类（类型）（ECMA 定义）</li>
<li>[[Code]] – 指向函数字节码的指针</li>
<li>native code（原生代码）– 指向原生函数代码的指针</li>
<li>Boolean [[PrimitiveValue]]（基础值）–  存储 Boolean 对象的 bool 值</li>
<li>Boolean [[PrimitiveValue]]（基础值）–  存储 Number 对象的数值</li>
</ul>
<h4 id="LCache">LCache<a class="post-anchor" href="#LCache"></a></h4><p>LCache是用于查找由对象和属性名称指定的属性的哈希表。 LCache 的对象-名称-属性布局在一行中连续显示多次，如下图：</p>
<p><a href="https://jerryscript.net/img/ecma_lcache.png" target="_blank" rel="noopener" data-caption data-fancybox="images"><img src="https://jerryscript.net/img/ecma_lcache.png" alt></a></p>
<p>访问属性时，将从所需的属性名称中提取hash值，然后使用该哈希值对 LCache 进行索引。 然后在索引行中搜索指定的对象和属性名称。</p>
<p>值得注意的是，如果在 LCache 中找不到指定的属性，这并不意味着它不存在（即LCache是可能返回的缓存）。 如果找不到该属性，则将在对象的属性列表中对其进行搜索，如果找到该属性则会将该属性放入LCache中。</p>
<h4 id="Collections">Collections<a class="post-anchor" href="#Collections"></a></h4><p>Collections 是类数组数据结构，优化用于节省内存。事实上，Collections是一个链表，其元素并非单个元素，而是一个包含多个元素的数组。</p>
<h4 id="Exception-Handling（异常处理）">Exception Handling（异常处理）<a class="post-anchor" href="#Exception-Handling（异常处理）"></a></h4><p>为了实现异常处理，JerryScript 的返回值能指示其错误或异常操作。其返回值是一个 ECMA 值，若发生错误操作则返回 ECMA_VALUE_ERROR 值。</p>
<h4 id="Value-Management-and-Ownership（值管理和所有权）">Value Management and Ownership（值管理和所有权）<a class="post-anchor" href="#Value-Management-and-Ownership（值管理和所有权）"></a></h4><p>引擎存储的每个 ECMA 值都与一个虚拟的 “所有权” 相关联，该所有权定义了如何管理该值：当不再需要它时何时释放它，以及如何将该值传递给其他功能。</p>
<p>最初，值是由其所有者（即用有所有权）分配的。 所有者有责任释放该值。 当将值作为参数传递给函数时，其所有权不会被传递，被调用函数必须制作一个自己的值副本。 但是，只要函数返回值，所有权就会传递，因此调用者将负责释放它。</p>


  
    <div class="post-reward">
    <div id="reward-button">打赏</div>
      <div id="qr">
        <div class="wrap">
            
            <div class="bg-wrap">
              <a href="/images/zhifubao.png" target="_block" class="bg" style="background-image:url('/images/zhifubao.png')"></a>
              支付宝
            </div>
            
            
            <div class="bg-wrap">
                <a href="/images/weixin.png" target="_block" class="bg" style="background-image:url('/images/weixin.png')"></a>
              微信
            </div>
            
        </div>
      </div>
    </div>
  
  <div class="post-guide">
    <div class="item left">
        
          <a href="/2019/12/05/end-2019/">写在 2019 的结尾</a>
        
    </div>
    <div class="item right">
        
          <a href="/2019/10/18/libuv-design/">libuv 架构设计概述</a>
        
    </div>
  </div>

  

  <div class="post-copyright">
    <div class="auth">
      本文作者：<a href="https://txiaozhe.github.io">Jim Tang</a>
    </div>
    <div class="link">
      永久链接：<a href="https://txiaozhe.github.io/2019/11/18/learning-jerryscript-design/">https://txiaozhe.github.io/2019/11/18/learning-jerryscript-design/</a>
    </div>
    <div class="declare">
      版权声明：本文首发于 <a href="https://txiaozhe.github.io">Jim Tang</a> 的博客，转载请注明出处！
    </div>
  </div>

  <div id="comment"></div>

  
  
</article>
        <footer>
          <div class="copyright">
            ©2017
            <a href="https://txiaozhe.github.io">Jim Tang</a> Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>
          </div>
          
        </footer>
      </div>
    </div>
  </body>
  
</html>
<script type="text/javascript">
                  window.HUHU_CONFIG = JSON.parse("{\"share\":[\"weibo\",\"weixin\",\"qqkongjian\",\"QQ\",\"zhihu\"],\"valine\":{\"API_ID\":\"q4HqCuoOlImXOnKpKNvO6aIn-gzGzoHsz\",\"API_KEY\":\"gABCd76E06dHRJ8m8hu4G2Sg\"},\"service_worker\":{\"open\":false}}")
                </script> <script type="text/javascript">window.addEventListener('load', function() {
    
    window.loadJs = function(d, m, a) {
      var c = document.getElementsByTagName('head')[0] || document.head || document.documentElement
      var b = document.createElement('script')
      b.defer = true
      b.setAttribute('type', 'text/javascript')
      b.setAttribute('charset', 'UTF-8')
      b.setAttribute('async', 'true')
      b.setAttribute('src', d)
      m && b.setAttribute('data-main', '/scripts/app-built')
      if (typeof a === 'function') {
        if (window.attachEvent) {
          b.onreadystatechange = function() {
            var e = b.readyState
            if (e === 'loaded' || e === 'complete') {
              b.onreadystatechange = null
              a()
            }
          }
        } else {
          b.onload = a
        }
      }
      c.appendChild(b)
    }
    window.loadJs && window.loadJs('https://cdn.bootcss.com/require.js/2.3.6/require.min.js', true, function() {require.config({"paths":{"util":"util","share":"share","search":"search","registerSW":"registerSW","valine":"cdn/Valine.min","av":["https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min"],"pjax":["https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min"],"jquery":["https://cdn.bootcss.com/jquery/3.4.1/jquery.min"],"confirm":["https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min"],"fancybox":["https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min"],"chart":["https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.bundle.min"]},"map":{"*":{"css":"https://cdn.bootcss.com/require-css/0.1.10/css.min.js"}},"shim":{"fancybox":{"deps":["css!https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css"]},"confirm":{"deps":["css!https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min.css"]},"chart":{"deps":["css!https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.min.css"]}},"waitSeconds":3})})
  })</script> <script type="text/javascript">
                  ;(function() {
                    var bp = document.createElement('script')
                    var curProtocol = window.location.protocol.split(':')[0]
                    if (curProtocol === 'https') {
                      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'
                    } else {
                      bp.src = 'http://push.zhanzhang.baidu.com/push.js'
                    }
                    var s = document.getElementsByTagName('script')[0]
                    s.parentNode.insertBefore(bp, s)
                  })()
                </script> 
